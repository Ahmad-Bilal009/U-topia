// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema
// Configured for Supabase PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL") // Optional: for migrations, use direct connection
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String   // Hashed password
  name      String?
  tier      String   @default("gold") // gold, silver, bronze
  role      String   @default("user") // user, director, admin
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  referralsAsReferrer Referral[] @relation("Referrer")
  referralsAsReferred Referral[] @relation("Referred")
  commissions         CommissionLedger[]

  @@index([email])
  @@index([role])
}

model Referral {
  id          String   @id @default(uuid())
  referrerId  String   // ID of the user who made the referral (user_id)
  referredId  String?  // ID of the user who was referred (referred_user_id, null until they sign up)
  referralCode String  @unique // Unique referral code
  status      String   @default("active") // active, verified, invalid, pending, completed, rewarded, used
  rewardAmount Float?  @default(0) // Reward amount if applicable
  createdAt   DateTime @default(now()) // timestamp
  updatedAt   DateTime @updatedAt

  // Relations (optional for now to handle existing data)
  referrer    User?    @relation("Referrer", fields: [referrerId], references: [id])
  referred    User?    @relation("Referred", fields: [referredId], references: [id])
  commissionLedger CommissionLedger[]

  @@index([referrerId])
  @@index([referredId])
  @@index([referralCode])
  @@index([status])
  @@index([createdAt])
}

model CommissionLedger {
  id          String   @id @default(uuid())
  userId      String   // ID of the user earning the commission
  referralId  String   // ID of the referral that generated this commission
  layer       Int      // Layer depth (1, 2, or 3)
  amount      Float    // Commission amount
  purchaseAmount Float  // Original purchase amount
  commissionRate Float // Commission rate used (as decimal, e.g., 0.12 for 12%)
  createdAt   DateTime @default(now()) // created_at

  // Relations
  user        User     @relation(fields: [userId], references: [id])
  referral    Referral @relation(fields: [referralId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([referralId])
  @@index([layer])
  @@index([createdAt])
}

